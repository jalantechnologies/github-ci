name: Test Security Scanning

on:
  workflow_call:
    inputs:
      docker_registry:
        required: false
        type: string
        description: 'Docker registry where built images will be pushed. By default uses Docker Hub.'
        default: registry.hub.docker.com
      docker_username:
        required: false
        type: string
        description: 'Username for authenticating with provided Docker registry'
    secrets:
      docker_password:
        required: false
        description: 'Password for authenticating with provided Docker registry'
    

jobs:
  test_scanning:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - uses: docker/setup-buildx-action@v3

      - name: Test Trivy scanning (should fail)
        uses: ./.github/actions/build
        id: build
        continue-on-error: true
        with:
          app_name: test-vulnerable
          tag: test
          context: tests/test-vulnerable-image
          trivy_severity: 'HIGH,CRITICAL'
          docker_registry: ${{ inputs.docker_registry }}
          docker_username: ${{ inputs.docker_username }}
          docker_password: ${{ secrets.docker_password }}

      - name: Verify scan failed
        if: steps.build.outcome == 'success'
        run: |
          echo "::error ::Trivy scan should have failed on vulnerable image"
          exit 1

      - name: Success
        if: steps.build.outcome == 'failure'
        run: echo "âœ… Trivy correctly detected vulnerabilities"